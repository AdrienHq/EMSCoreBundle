{% extends 'EMSCoreBundle::base.html.twig' %}{% trans_default_domain 'EMSCoreBundle' %}

{% block title %}Revisions of {{ revision.contentType.singularName }} : {{ revision.ouuid }}{% endblock %}
{% block pagetitle %}
	<i class="{% if revision.contentType.icon %}{{ revision.contentType.icon }} {% else %} fa fa-question {% endif %} "></i>
	Revisions of {{ revision.contentType.name }} : {% if revision.labelField %}{{ revision.labelField }}{% else %}{{ revision.ouuid }}{% endif %}
{% endblock %} 
{% block subtitle %}<small>You are viewing the last revision as defined in eMS</small>{% endblock %} 


{% block body %}
{% import "EMSCoreBundle:macros:data-field-type.html.twig" as macros %}
<div class="row">
	<div class="col-md-12">

		<div class="box box-primary">            <!-- /.box-body -->
			<div class="box-footer">
				{% include 'EMSCoreBundle:elements:revision-toolbar.html.twig' with {
								'revisionId' : revision.id,
								'environments': revision.environments,
								'draft': revision.draft,
								'current': not revision.endTime,
								'autoSave': revision.autoSave,
								'instance': revision,
								'withView': false,
								'vertical': false,
				}%}
					
			</div>
          </div>
         </div>
      </div>
<div class="row">
        
	<div class="col-md-3">

		<div class="box box-primary">
            <div class="box-header with-border">
              <h3 class="box-title">About this revision</h3>
            </div>
            <!-- /.box-header -->
            <div class="box-body">
              <strong><i class="fa fa-map-signs margin-r-5"></i> Status</strong>

              <p class="text-muted">
                	{% if revision.draft %}
						<i class="fa fa-fire"></i>
						Draft in progress
					{% elseif not revision.endTime %}
						<i class="fa fa-thumbs-up"></i>
						Current revision
					{% else %} 
						<i class="fa fa-clock-o"></i>
						Previous revision ({{ revision.startTime|date(date_time_format) }})
					{% endif %}
              </p>

              {% if revision.finalizedBy %}
                  <hr>
	              <strong><i class="fa fa-user margin-r-5"></i> {{ 'Finalized by'|trans }}</strong>
	              <p class="text-muted">{{ revision.finalizedBy|displayname }}</p>
              {% endif %}

              <hr>
              <strong><i class="fa fa-clock-o margin-r-5"></i> Creation date</strong>
              <p class="text-muted">{{ revision.created|date(date_time_format) }}</p>

              <hr>

              <strong><i class="fa fa-pencil margin-r-5"></i> Last update</strong>

              <p class="text-muted">{{ revision.modified|date(date_time_format) }}</p>

              {% if revision.lockby %}
                  <hr>

	              <strong><i class="fa fa-user margin-r-5"></i> Modified by</strong>
	
	              <p class="text-muted">{{ revision.lockby|displayname }}</p>
	
              {% endif %}
              
              {% if revision.notifications|length > 0 %}
	              <hr>
	              <strong><i class="fa fa-hourglass-end margin-r-5"></i> {{ 'Pending'|trans }}</strong>
	
	              <p class="text-muted">
	              	{% set notificationFound = false %}
					{% for notification in revision.notifications %}
						{% if notification.status == 'pending'  %}
			                <span class="label label-default"><i class="fa {{ notification.template.icon }}"></i> {{ notification.template.name }}</span>
			                {% set notificationFound = true %}
			            {% endif %}
					{% endfor %}
    				{% if not notificationFound %}
    					{{ 'Nothing'|trans }}
    				{% endif %}
	              </p>
	
              {% endif %}
              {% if circles_object and revision.circles|length > 0 %}
                  <hr>
              	{% set circleContentType = circles_object|get_content_type %}
	              <strong><i class=" {% if circleContentType.icon %}{{ circleContentType.icon }}{% else %}fa fa-circle-o{% endif %} margin-r-5"></i> {{ circleContentType.pluralName }}</strong>
	
	              <p class="text-muted">
	              	{% for circle in revision.circles %}
	              		{{ circle|data_link|raw }}
	              	{% endfor %}
	              </p>
              {% endif %}
            </div>
            <!-- /.box-body -->
          </div>
          
	</div>
	<div class="col-md-9">
		<div class="box revision-view">
			<div class="box-header with-border bg-{{ revision.contentType.color }} color-palette">
				<h3 class="box-title">
					{% if revision.draft %}
						<i class="fa fa-fire"></i>
						Draft in progress
					{% elseif not revision.endTime %}
						<i class="fa fa-thumbs-up"></i>
						Current revision
					{% else %} 
						<i class="fa fa-clock-o"></i>
						Previous revision ({{ revision.startTime|date(date_time_format) }})
					{% endif %}
				</h3>
			</div>
			<!-- /.box-header -->
			<!-- form start -->
			<div class="box-body">
				{{ macros.renderDataField(revision.dataField) }}
			</div>
			<!-- /.box-body -->
			<div class="box-footer">
				{% include 'EMSCoreBundle:elements:revision-toolbar.html.twig' with {
								'revisionId' : revision.id,
								'environments': revision.environments,
								'draft': revision.draft,
								'current': not revision.endTime,
								'autoSave': revision.autoSave,
								'instance': revision,
								'withView': false,
				}%}
					
			</div>
		</div>
	</div>
</div>

<div class="row">
	<div class="col-xs-12">

	</div>
</div>
<div class="row">

<div class="col-xs-12">
          <!-- Custom Tabs -->
          <div class="nav-tabs-custom">
            <ul class="nav nav-tabs">
              <li class="active"><a href="#tab_referrers" data-toggle="tab" aria-expanded="true">{{ 'Linked documents'|trans }} <small>{{ referrers.hits.hits|length }}/{{ referrers.hits.total }}</small></a></li>
              <li class=""><a href="#tab_revisions" data-toggle="tab" aria-expanded="false">Revisions <small>{{ revisionsSummary|length }}/{{ counter }}</small></a></li>
            </ul>
            <div class="tab-content">
              <div class="tab-pane active" id="tab_referrers">
	              <div class="box">
					<div class="box-body">
						{% if referrers.hits.total == 0 %}
							{{ 'This document does not have any linked document'|trans }}
						{% else %}
						
							<div class="btn-group">
								{% for obj in referrers.hits.hits %}
									{{ (obj._type~':'~obj._id)|data_link|raw }}
								{% endfor %}
							</div>
						{% endif %}
					</div>
					
					<div class="box-footer">
						<div class="btn-group">
							<a href="{{ path('elasticsearch.search', {
			            		'search_form[sortBy]': '_uid',
			            		'search_form[sortOrder]': 'asc',
			            		'search_form[filters][0][booleanClause]' : referrersFilter.booleanClause,
			            		'search_form[filters][0][field]' : referrersFilter.field,
			            		'search_form[filters][0][operator]' : referrersFilter.operator,
			            		'search_form[filters][0][pattern]' : referrersFilter.pattern
								} ) }}" class="btn btn-primary"><i class="fa fa-search"></i> {{ 'All linked documents' }}</a>
						</div>
					</div>
				</div>
              </div>
              <!-- /.tab-pane -->
              <div class="tab-pane" id="tab_revisions">

				<div class="box">
					<!-- /.box-header -->
					<div class="box-body">
						<div class="table-responsive">
						<table class="table table-bordered">
							<tbody>
								<tr>
									<th style="width: 10px">#</th>
									<th>Date</th>
									<th>Locked</th>
									<th>Autosave</th>
									<th>Environments</th>
									<th>Pendings</th>
									<th>Actions</th>
								</tr>
								{% for rev in revisionsSummary %}
								<tr {% if rev.id == revision.id %}class="bg-{{ revision.contentType.color }}"{% endif %}>
									<td>{{ loop.index+firstElemOfPage }}.</td>
									<td>{{ rev.created|date|date(date_time_format) }}</td>
									<td>
										{% if rev.lockUntil and rev.lockUntil > date('now') %}
											by {{ rev.lockBy }} <br>
											until  {{ rev.lockUntil|date(date_time_format) }}
										{% endif %}
									</td>
									<td>
										{% if rev.autoSave %}
											by {{ rev.autoSaveBy }} <br>
											at {{ rev.autoSaveAt|date(date_time_format) }}
										{% endif %}
									</td>
									<td>
										{% for env in rev.environments %}
											<span class="badge bg-{{ env.color|raw }}">{{ env.name|humanize }}</span>
										{% endfor %}
										{% if rev.draft %} 	
											<span class="badge bg-red">Draft in progress</span>
										{% endif %}
									</td>
									<td>
										{% for notification in rev.notifications %}
											{% if notification.status == 'pending'  %}
								                <span class="label label-default"><i class="fa {{ notification.template.icon }}"></i> {{ notification.template.name }}</span>
								            {% endif %}
										{% endfor %}
															
									</td>
									<td>
									{% include 'EMSCoreBundle:elements:revision-toolbar.html.twig' with { 
										'revisionId' : rev.id,
										'environments': rev.environments,
										'draft': rev.draft,
										'current': not rev.endTime,
										'autoSave': rev.autoSave,
										'instance': revision
									}%}
									</td>
								</tr>
								{% endfor %}
							</tbody>
						</table>
						</div>
					</div>
					<div class="box-footer">
						{% include 'EMSCoreBundle:elements:pagination.html.twig' with {
							'lastPage': lastPage,
							'currentPage': page,
							'currentFilters': app.request.query|merge({ type: revision.contentType.name , ouuid: revision.ouuid , revisionId: revision.id}),
							'paginationPath': 'data.revisions',
							'showAlwaysFirstAndLast': false
						} %}
					</div>
				</div>

              </div>
              <!-- /.tab-pane -->
            </div>
            <!-- /.tab-content -->
          </div>
          <!-- nav-tabs-custom -->
        </div>
</div>
{% endblock %}

{% block javascripts %}
	{% if revision.draft %}
		{% include 'EMSCoreBundle:app:menu.html.twig' with {
			'item':  'data-draft-' ~ revision.contentType.id
		}%}
	{% else %}
		{% include 'EMSCoreBundle:app:menu.html.twig' with {
			'item':  'data-index-' ~ revision.contentType.id
		}%}
	{% endif %}
	
<script src="{{ asset('bundles/emscore/bower/ace-builds/src-min-noconflict/ace.js') }}"></script>
	
<script type="text/javascript">
    $(window).ready(function() {
    	$(".ems-code-editor").each(function(){
    		var editor = ace.edit(this);
    		if($(this).data('theme')){
        	    editor.setTheme($(this).data('theme'));
    		}
    		if($(this).data('language')){
        	    editor.session.setMode($(this).data('language'));
    		}
    		var maxLines = 15;
    		if($(this).data('max-lines') && $(this).data('max-lines') > 0){
    			maxLines = $(this).data('max-lines');
    		}
    		editor.setOptions({
    		    readOnly: true,
    		    highlightActiveLine: false,
    		    highlightGutterLine: false,
    		    maxLines: maxLines
    		});
    		editor.renderer.$cursorLayer.element.style.opacity=0;
    		editor.textInput.getElement().tabIndex=-1;
    		editor.commands.commmandKeyBinding={};
    	});
    });
</script>
{% endblock %}	